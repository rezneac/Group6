<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Savings Progress</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #aaa;
        }

        .progress-and-goal-container {
            display: flex; align-items: baseline; column-gap: 1em;
        }

        .progress-container {
            flex-grow: 1;
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            height: 30px;
            margin-bottom: 20px;
        }
        .progress-bar {
            height: 30px;
            text-align: center;
            color: white;
            line-height: 30px;
            transition: width 0.5s;
        }
        .progress-goal {
            display: block; 
            white-space: nowrap; 
            font-size: larger;
        }
        .username {
            font-weight: bold;
        }
        .global-progress-title {
            margin-top: 40px;
            font-size: 1.2em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Savings Progress</h1>

    <!-- Global Stacked Progress Bar -->
    <div class="global-progress-title">Total Savings Progress</div>

    <div class="progress-and-goal-container">
        <div id="global-progress-container" class="progress-container"></div>
        <div id="global-progress-goal" class="progress-goal">Holiday Fund</div>
    </div>

    <form action="{{ url_for('set_savings_goal') }}" method="POST">
        <label for="target_amount">New Savings Goal:</label> <!-- Set how much you are saving. --> 
        <input type="number" id="target_amount" name="target_amount" min="0.01" step="0.01" required>
        
        <button type="submit">Reset Savings</button>
    </form>
    

    <button>Update Savings Goal</button> <!-- Set what you are saving for -->
    
    <h2>Individual Contributions</h2>
    <div id="users-container"></div>

    <script>
        // Generate a consistent color for each user
        function getUserColor(username) {
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            const color = `hsl(${hash % 360}, 70%, 50%)`; // Unique color based on username
            return color;
        }

        // Fetch savings data from the Flask backend
        async function fetchSavingsData() {
            try {
                const response = await fetch('/savings');
                const savingsData = await response.json();
                displaySavingsProgress(savingsData);
            } catch (error) {
                console.error('Error fetching savings data:', error);
            }
        }

        // Display savings progress for individual users and overall progress
        function displaySavingsProgress(savingsData) {
            const usersContainer = document.getElementById('users-container');
            const globalProgressContainer = document.getElementById('global-progress-container');
            
            usersContainer.innerHTML = '';  // Clear previous content
            globalProgressContainer.innerHTML = '';

            let totalGoal = savingsData["goal"]["target_amount"]
            let totalSaved = savingsData["users"].reduce((sum, user) => sum + user.saved_amount, 0);

            // Global stacked progress bar (total savings)
            if (totalSaved > 0) {
                savingsData["users"].forEach(user => {
                    if (user.saved_amount > 0) {
                        const progressSegment = document.createElement('div');
                        progressSegment.classList.add('progress-bar');
                        progressSegment.style.width = `${(user.saved_amount / totalGoal) * 100}%`;
                        progressSegment.style.backgroundColor = getUserColor(user.username);
                        progressSegment.textContent = `£${user.saved_amount}`;
                        globalProgressContainer.appendChild(progressSegment);
                    }
                });
            } else {
                globalProgressContainer.textContent = "No savings yet.";
            }

            document.getElementById("global-progress-goal").textContent = savingsData["goal"]["name"];

            // Individual user progress bars
            savingsData["users"].forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.classList.add('user-progress');

                const usernameDiv = document.createElement('div');
                usernameDiv.classList.add('username');
                usernameDiv.textContent = `${user.username} - Goal: £${totalGoal}, Saved: £${user.saved_amount}`;

                const progressAndGoalContainer = document.createElement('div');
                progressAndGoalContainer.classList.add('progress-and-goal-container');

                const progressContainer = document.createElement('div');
                progressContainer.classList.add('progress-container');

                const goalText = document.createElement('div');
                goalText.textContent = savingsData["goal"]["name"];
                goalText.classList.add("progress-goal");

                if (user.saved_amount > 0) {
                    console.table(user.contributions);
                    user.contributions.forEach(contrib => {
                        const progressBar = document.createElement('div');
                        progressBar.classList.add('progress-bar');
                        progressBar.style.width = `${(contrib.amount / totalGoal) * 100}%`;
                        progressBar.style.backgroundColor = getUserColor(contrib.username);
                        progressBar.textContent = `£${contrib.amount}`;
                        progressContainer.appendChild(progressBar);
                    });
                } else {
                    progressContainer.textContent = "No savings yet.";
                }

                progressAndGoalContainer.appendChild(progressContainer);
                progressAndGoalContainer.appendChild(goalText);


                userDiv.appendChild(usernameDiv);
                userDiv.appendChild(progressAndGoalContainer);
                usersContainer.appendChild(userDiv);
            });
        }

        // Fetch savings data when the page loads
        fetchSavingsData();
    </script>
</body>
</html>